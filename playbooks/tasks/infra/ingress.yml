---
- name: Add stable chart repo
  community.kubernetes.helm_repository:
    name: stable
    repo_url: "https://kubernetes-charts.storage.googleapis.com"

- name: Add ingress_nginx helm repo
  community.kubernetes.helm_repository:
    name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx

- name: Create namespaces
  community.kubernetes.k8s:
    api_version: v1
    kind: Namespace
    name: '{{ item }}'
  loop:
    - metallb-system
    - ingress-nginx

- name: Install MetalLB
  community.kubernetes.helm:
    name: metallb
    namespace: metallb-system
    chart_ref: stable/metallb
    values:
      configInline:
        address-pools:
        - name: default
          protocol: layer2
          addresses:
          - '{{ metallb_ip_range }}'

- name: Install ingress_nginx
  community.kubernetes.helm:
    name: ingress-nginx
    namespace: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
